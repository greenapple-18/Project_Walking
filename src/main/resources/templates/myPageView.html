<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>My Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</head>
<body>

<div class="container mt-5">
    <h3><span th:text="${currentUserInfo.name}"></span> 님의 마이페이지</h3>

    <section class="first_section">
        <!-- 사용자 기본 정보 섹션 -->
        <div class="info_1">
            <p>내 등급: </p>

            <p>팔로워: <span th:text="${currentUserInfo.followers}"></span>명</p>
            <!-- 팔로워 목록 보기 링크 -->
            <a href="#" id="followerLink" class="btn btn-info" data-toggle="modal" data-target="#followerModal">팔로워 목록 보기</a>

            <p>팔로잉: <span th:text="${currentUserInfo.following}"></span>명</p>
            <!-- 팔로잉 목록 보기 링크 -->
            <a href="#" id="followingLink" class="btn btn-info" data-toggle="modal" data-target="#followingModal">팔로잉 목록 보기</a>

            <p>프로필 사진: <img th:src="${currentUserInfo.profileImage}" alt="Profile Image" width="100"></p>
        </div>

        <div class="info_2">
            <p>이메일: <span th:text="${currentUserInfo.email}"></span></p>
            <p>전화번호: <span th:text="${currentUserInfo.phone}"></span></p>
            <button class="btn btn-primary" data-toggle="modal" data-target="#updateInfoModal">내 정보 수정</button>
        </div>
    </section>

    <!-- 팔로워 목록 모달 -->
    <div class="modal fade" id="followerModal" tabindex="-1" role="dialog" aria-labelledby="followerModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="followerModalLabel">팔로워 목록</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul id="followerList"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 팔로잉 목록 모달 -->
    <div class="modal fade" id="followingModal" tabindex="-1" role="dialog" aria-labelledby="followingModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="followingModalLabel">팔로잉 목록</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul id="followingList"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- todo 프로필 사진 추가하기 -->
    <!-- 내 정보 수정 모달 -->
    <div class="modal fade" id="updateInfoModal" tabindex="-1" role="dialog" aria-labelledby="updateInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateInfoModalLabel">내 정보 수정</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="password">비밀번호</label>
                        <input type="password" class="form-control" id="password" placeholder="새 비밀번호를 입력하세요" required>
                        <small class="form-text text-muted">최소 8자 이상, 문자, 숫자, 특수문자 포함</small>
                    </div>
                    <div class="form-group">
                        <label for="phone">전화번호</label>
                        <input type="text" class="form-control" id="phone" placeholder="전화번호 입력" required>
                        <small class="form-text text-muted">010-1234-5678 형식으로 입력해 주세요.</small>
                    </div>
                    <div class="form-group">
                        <label for="nickname">닉네임</label>
                        <input type="text" class="form-control" id="nickname" placeholder="닉네임 입력" required>
                        <small class="form-text text-muted">1자에서 15자 사이여야 합니다.</small>
                    </div>
                    <div class="form-group">
                        <label for="profileImage">프로필 이미지 URL</label>
                        <input type="text" class="form-control" id="profileImage" placeholder="프로필 이미지 URL 입력">
                    </div>
                    <button id="updateUserBtn" class="btn btn-primary">정보 수정</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>


    <hr>

    <!-- 사용자 아이템 목록 버튼 -->
    <button class="btn btn-primary" data-toggle="modal" data-target="#myItemsModal">보유 아이템</button>

    <!-- 사용자 포인트 로그 버튼 -->
    <button class="btn btn-secondary" data-toggle="modal" data-target="#myPointLogsModal">포인트 사용 내역</button>

    <!-- 사용자 아이템 목록 모달 -->
    <div class="modal fade" id="myItemsModal" tabindex="-1" role="dialog" aria-labelledby="myItemsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myItemsModalLabel">My Items</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- todo 굿즈 이름이 필요할 것 같음  // 표시 형식 : 아이템 이름 x 갯수-->
                    <ul th:each="myitem : ${myItems}">
                        <li th:text="${myitem.goodsId}"> x <span th:text="${myitem.amount}"></span></li>

                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 포인트 로그 모달 -->
    <div class="modal fade" id="myPointLogsModal" tabindex="-1" role="dialog" aria-labelledby="myPointLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myPointLogsModalLabel">Point Logs</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul th:each="log : ${pointLogs}">
                        <li th:text="${log.description}"></li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    $(document).ready(function() {
        var userId = window.location.pathname.split("/").pop(); // "/mypage/1"에서 "1"을 가져옵니다.

        $('#updateUserBtn').click(function() {
            var password = $('#password').val();
            var phone = $('#phone').val();
            var nickname = $('#nickname').val();
            var profileImage = $('#profileImage').val();

            $.ajax({
                url: '/users/' + userId,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    password: password,
                    phone: phone,
                    nickname: nickname,
                    profileImage: profileImage
                }),
                success: function(response) {
                    alert('정보가 업데이트되었습니다.');
                    $('#updateInfoModal').modal('hide');
                    // 필요 시 사용자 정보 새로 고침
                    window.location.reload();
                },
                error: function(xhr, status, error) {
                    alert('정보 업데이트 중 오류가 발생했습니다.');
                }
            });
        });

        // 팔로워 목록 요청
        // todo 목록 볼 때마다 자꾸 늘어나는 버그 고치기
        $('#followerLink').click(function() {
            $.ajax({
                url: '/users/' + userId + '/follower',
                type: 'GET',
                success: function(followers) {
                    var followerList = $('#followerList');
                    followers.forEach(function(follower) {
                        var listItem = $('<div class="follower-item"></div>');
                        //
                        listItem.append('<img src="http://via.placeholder.com/50x50" alt="profile_image" width="500" />');
                        listItem.append('<span>' + follower.nickname + '</span>');
                        followerList.append(listItem);
                    });
                    $('#followerModal').modal('show'); // 모달 창 표시
                },
                error: function() {
                    alert('팔로워 목록을 불러오는 데 실패했습니다.');
                }
            });
        });

        // 팔로잉 목록 요청
        $('#followingLink').click(function() {
            $.ajax({
                url: '/users/' + userId + '/following',
                type: 'GET',
                success: function(followings) {
                    var followingList = $('#followingList');
                    followings.forEach(function(following) {
                        var listItem = $('<div class="following-item"></div>');
                        listItem.append('<img src="http://via.placeholder.com/50x50" alt="profile_image" width="500" />');
                        listItem.append('<span>' + following.nickname + '</span>');
                        followingList.append(listItem);
                    });
                    $('#followingModal').modal('show'); // 모달 창 표시
                },
                error: function() {
                    alert('팔로잉 목록을 불러오는 데 실패했습니다.');
                }
            });
        });
    });
</script>

</html>
